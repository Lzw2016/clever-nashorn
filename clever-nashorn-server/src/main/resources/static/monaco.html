<!DOCTYPE html>
<html lang="zh">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>首页</title>
    <script src="./vConsole/vconsole.min.js"></script>
    <script>
        // 初始化
        var vConsole = new VConsole({
            defaultPlugins: [],
            onReady: function () {
                $("#__vconsole .vc-panel").css({"min-height": "55%"});
            }
        });
    </script>
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css"/>
    <style>
        .monaco-editor {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }

        .fullscreen[data-theme=vs-dark] {
            z-index: 5;
            position: absolute;
            top: 8px;
            right: 24px;
            padding: 5px;
            color: #999;
        }

        .fullscreen[data-theme=vs-dark]:hover {
            cursor: pointer;
            color: #ddd;
        }

        .active[data-theme=vs-dark] {
            color: #fff !important;
            font-size: 18px;
        }

        .fullscreen[data-theme=vs] {
            z-index: 5;
            position: absolute;
            top: 8px;
            right: 24px;
            padding: 5px;
            color: #888;
        }

        .fullscreen[data-theme=vs]:hover {
            cursor: pointer;
            color: #555;
        }

        .active[data-theme=vs] {
            color: #111 !important;
            font-size: 18px;
        }
    </style>
</head>

<body style="margin: 0;">
<div class="fullscreen" data-theme="dark">
    <i id="debugBtn" title="调试" class="monaco-editor-background fa fa-bug" data-theme="vs"></i>
    <!--<i title="全屏/取消全屏" class="monaco-editor-background fa fa-arrows-alt fullscreen" data-theme="vs"></i>-->
</div>

<div id="container" class="monaco-editor"></div>
</body>

<script type="text/javascript" src="jquery/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="lodash/lodash.min.js"></script>
<script type="text/javascript" src="monaco-editor/nashorn-js.js"></script>
<script type="text/javascript" src="monaco-editor/min/vs/loader.js"></script>
<script type="text/javascript">
    // 初始化配置
    require.config({
        paths: {'vs': 'monaco-editor/min/vs'},
        'vs/nls': {
            availableLanguages: {
                '*': 'zh-cn'
            }
        }
    });

    // // 全屏/取消全屏
    // function fullscreen(full) {
    //     var node = $(".fullscreen");
    //     if (full === true) {
    //         node.addClass("active");
    //     } else if (full === false) {
    //         node.removeClass("active");
    //     } else {
    //         node.toggleClass("active");
    //     }
    // }

    // // 全屏事件
    // $(".fullscreen").on("click", function () {
    //     if (fullscreenFunc) {
    //         fullscreen();
    //         fullscreenFunc();
    //     }
    // });

    var editor;
    var fullscreenFunc;

    // 初始化编辑器
    function initEditor(config, setEditorFunc) {
        if (config) {
            fullscreenFunc = config.fullscreen;
        }
        require(['vs/editor/editor.main'], function () {
            // console.log(monaco.editor);
            // 自定义编辑器 https://github.com/microsoft/monaco-editor-samples/blob/master/browser-amd-monarch/index.html
            // monaco.languages.register({id: 'nashorn-js'});
            // monaco.languages.setMonarchTokensProvider('nashorn-js', nashornJS);
            // 属性配置 https://microsoft.github.io/monaco-editor/api/interfaces/monaco.editor.ieditorconstructionoptions.html
            var options = {
                // 主题，三款：vs、vs-dark、hc-black
                theme: 'vs-dark',
                // 内容
                value: '',
                // 语言
                language: 'javascript',
                // 显示行号
                lineNumbers: true,
                // 只读属性
                readOnly: false,
                // 光标样式 'block' or 'line'
                cursorStyle: 'line',
                // 字体大小
                fontSize: 14,
                // 自适应调整
                automaticLayout: false,
                // 右键菜单
                contextmenu: true,
                //代码略缩图
                minimap: {
                    enabled: false
                }
            };
            options = $.extend(true, options, config);
            if (options.theme === "vs") {
                $(".fullscreen").attr("data-theme", "vs");
            } else {
                $(".fullscreen").attr("data-theme", "vs-dark");
            }
            // 创建编辑器
            editor = monaco.editor.create(document.getElementById('container'), options);
            // 增加快捷键(可覆盖默认快捷键)
            editor.addCommand(
                monaco.KeyMod.Alt | monaco.KeyCode.US_SLASH,
                function () {
                    editor.trigger(null, 'editor.action.triggerSuggest', {});
                },
                '!findWidgetVisible && !inReferenceSearchEditor && !editorHasSelection'
            );
            editor.addCommand(
                monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KEY_U,
                function () {
                    editor.trigger(null, 'editor.action.transformToUppercase', {});
                }
            );
            editor.addCommand(
                monaco.KeyMod.CtrlCmd | monaco.KeyMod.Shift | monaco.KeyCode.KEY_I,
                function () {
                    editor.trigger(null, 'editor.action.transformToLowercase', {});
                }
            );
            if (setEditorFunc) setEditorFunc(editor);
        });
    }

    // 设置值
    function setValue(value) {
        editor.setValue(value);
    }

    // 获取值
    function getValue() {
        return editor.getValue();
    }

    // 内容改变事件
    // editor.onDidChangeModelContent(function (e) {
    //   console.log(e);
    // });

    // 设置主题 vs、vs-dark、hc-black
    function setTheme(theme) {
        monaco.editor.setTheme(theme);
    }

    // 改变属性
    function updateOptions(config) {
        editor.updateOptions(config || {});
    }

    // 大小发生变化
    window.addEventListener(
        'resize',
        _.debounce(
            function () {
                if (!editor) return;
                editor.layout();
            },
            100,
            {maxWait: 350}
        )
    );

    // --------------------------------------------------------------------------------------------------------------

    var isDebug = false;

    function debug() {
        isDebug = true;
        var ws = new WebSocket("ws://127.0.0.1:18081/ws/debug");
        ws.onopen = function () {
            console.log("已连接服务器...");
            ws.send(JSON.stringify({
                type: 'normal',
                filePath: '/',
                fileName: './public/tmp.js',
                fucName: 'test'
            }));
        };

        ws.onmessage = function (evt) {
            var data = JSON.parse(evt.data);
            // console.log(data.log);
            // console.log(data.logs);
            if (data.type === "log") {
                var _console;
                // 日志前缀 [2019-08-28  11:52:17.208] [INFO] index.js -
                var logs = [
                    "[".concat(data.logTime, "] "),
                    "[".concat(data.level.toUpperCase(), "] "),
                    data.fileName ? (data.filePath + data.fileName) : "",
                    " - "
                ].concat(data.logs);
                switch (data.level) {
                    case "trace":
                        (_console = console).trace.apply(_console, logs);
                        break;
                    case "debug":
                        (_console = console).debug.apply(_console, logs);
                        break;
                    case "info":
                        (_console = console).info.apply(_console, logs);
                        break;
                    case "warn":
                        (_console = console).warn.apply(_console, logs);
                        break;
                    case "error":
                        (_console = console).error.apply(_console, logs);
                        break;
                    default:
                        (_console = console).log.apply(_console, logs);
                }
            }
        };

        ws.onclose = function (evt) {
            isDebug = false;
            console.warn("关闭与服务器的连接！");
        };

        ws.onerror = function (evt) {
            console.error("连接服务器错误", evt);
        };
    }

    initEditor({
        width: "100%",
        height: "100%",
        "last": "last"
    });

    var id = 12;
    $.ajax({
        url: "/api/js_code_file/" + id,
        type: "GET",
        async: true,
        contentType: "application/json; charset=utf-8",
        // data: JSON.stringify({}),
        dataType: "json",
        success: function (result) {
            // console.log(result);
            setValue(result.jsCode);
        }
    });

    $("#debugBtn").on("click", function () {
        if (isDebug) return;
        vConsole.show();
        // 保存数据
        $.ajax({
            url: "/api/js_code_file/" + id,
            type: "PUT",
            async: true,
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({jsCode: getValue()}),
            dataType: "json",
            success: function (result) {
                debug();
            }
        });
    });
</script>
</html>
